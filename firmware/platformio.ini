; Racing Dashboard Firmware - PlatformIO Configuration
; Based on PMU_30 architecture
; Target: STM32H743/H753 + TFT Display (1024x600)

[platformio]
default_envs = racing_dash_debug

; =============================================================================
; Common Settings
; =============================================================================

[common]
platform = ststm32
board = genericSTM32H743VI
framework = stm32cube

build_flags =
    -D STM32H743xx
    -D USE_HAL_DRIVER
    -D USE_FULL_LL_DRIVER
    -D ARM_MATH_CM7
    -D __FPU_PRESENT=1
    ; FreeRTOS
    -D FREERTOS_ENABLED
    ; Hardware
    -D DISPLAY_WIDTH=1024
    -D DISPLAY_HEIGHT=600
    -D HAL_LTDC_MODULE_ENABLED
    -D HAL_DMA2D_MODULE_ENABLED
    -D HAL_SDRAM_MODULE_ENABLED
    -D HAL_CAN_MODULE_ENABLED
    -D HAL_ADC_MODULE_ENABLED
    -D HAL_UART_MODULE_ENABLED
    -D HAL_SPI_MODULE_ENABLED
    -D HAL_I2C_MODULE_ENABLED
    -D HAL_SD_MODULE_ENABLED
    ; Float printf support
    -D _GLIBCXX_USE_CXX11_ABI=0
    -Wl,-u_printf_float
    ; Optimization
    -ffunction-sections
    -fdata-sections
    ; FPU
    -mfpu=fpv5-d16
    -mfloat-abi=hard

lib_deps =
    FreeRTOS-Kernel@^10.5.1
    cJSON@^1.7.17
    lvgl/lvgl@^8.3.11

upload_protocol = stlink
debug_tool = stlink
monitor_speed = 115200

; =============================================================================
; Debug Build
; =============================================================================

[env:racing_dash_debug]
extends = common

build_flags =
    ${common.build_flags}
    -D DEBUG
    -D RD_DEBUG_LOGGING=1
    -D RD_LOG_LEVEL=4
    -Og
    -g3

; =============================================================================
; Release Build
; =============================================================================

[env:racing_dash_release]
extends = common

build_flags =
    ${common.build_flags}
    -D NDEBUG
    -D RD_DEBUG_LOGGING=0
    -D RD_LOG_LEVEL=1
    -O2
    -flto

build_unflags =
    -Og
    -g3

; =============================================================================
; Unit Test Environment (Native)
; =============================================================================

[env:racing_dash_test]
platform = native
build_flags =
    -D UNIT_TEST
    -D RD_DEBUG_LOGGING=1
    -std=c11
    -g

lib_deps =
    cJSON@^1.7.17

; =============================================================================
; Hardware Emulator (PC-based testing)
; =============================================================================

[env:racing_dash_emulator]
platform = native
build_flags =
    -D EMULATOR
    -D RD_DEBUG_LOGGING=1
    -D RD_LOG_LEVEL=4
    -D DISPLAY_WIDTH=1024
    -D DISPLAY_HEIGHT=600
    -std=c11
    -g
    -lSDL2
    -lpthread

lib_deps =
    cJSON@^1.7.17
    lvgl/lvgl@^8.3.11

extra_scripts =
    pre:emulator/emulator_pre.py
