# Черновой рантайм firmware (C + TouchGFX/LVGL)

Этот пример иллюстрирует модульную прошивку приборной панели на чистом C. Он охватывает:
- фильтрацию входов и расчёт производных каналов (math channels);
- приоритезированную логику переключения экранов и алертов;
- управление яркостью от датчика освещённости с ручным override;
- два UI-стека: TouchGFX (стиль Motec) и альтернативу на LVGL;
- внешнее видео (HDMI/CarPlay/Android Auto) с оверлеем;
- логгер событий для отладки.

## Ключевые компоненты
- `SignalBus` — общая шина значений, в которую пишут драйверы ввода и math-каналы.
- `MathEngine` — вычисляет производные каналы (скорость, уровень shift-light и т.д.).
- `AlertManager` — алерты с уровнями (info/warn/crit).
- `DisplayManager` — переключает экраны по условиям с приоритетами, рендерит оверлей.
- `BrightnessController` — переводит освещённость в уровень подсветки, поддерживает ручной режим.
- `ExternalInputManager` — абстракция над HDMI/CarPlay/Android Auto, оставляет оверлей поверх видеопотока.
- `DataLogger` — собирает события рантайма для быстрой диагностики.
- `HealthMonitor` — проверяет свежесть сигналов.
- `Runtime` — фасад над всеми подсистемами, принимает `RuntimeProfile` (экраны, условия, math-каналы, правила здоровья)
  и публикует обновления через `runtime_step()`.

## Быстрый старт
1. Откройте `src/main.c` и посмотрите вызовы `demo_touchgfx` и `demo_lvgl`.
2. Профили экранов и маршрутов собраны в `runtime.c` через `RuntimeProfile` (экраны, условия, алерты, math-каналы, правила свежести).
3. `runtime_ingest()` принимает значения сенсоров, `runtime_set_brightness()` — авто/ручную подсветку, `runtime_set_external()` — источник
   видео. После этого вызывайте `runtime_step()` в цикле.

## TouchGFX: как собраны экраны
- Экран `main`: RPM, скорость, охлаждайка/масло, батарея, буст, дроссель.
- Экран `warning`: давления и температуры с подчёркиванием проблемных зон.
- Экран `race`: RPM, shift-light, буст, положение заслонки.

## LVGL-вариант
- Экран `cluster`: RPM, буст, дроссель, батарея в компактном виде.
- Экран `health`: давления масла/топлива и аларм при просадке.

## Демо-режим
Демо-скрипт генерирует несколько кадров:
- базовый холостой ход/прогрев;
- «lap attack» с 8450 RPM, бустом 185 кПа, просадкой давления масла/топлива и обеднением смеси;
- HDMI и CarPlay с сохранением оверлея shift-light.

Используемые каналы сенсоров: `rpm`, `coolant_temp`, `oil_temp`, `oil_pressure`, `fuel_pressure`, `boost_kpa`, `throttle`, `lambda_current/target`, `battery_voltage`, `ambient_temp`, `gear_ratio`, `pit_limiter`.

## Превью экранов
Текстовые макеты TouchGFX и LVGL находятся в [docs/screen_previews.md](screen_previews.md) — можно быстро посмотреть расположение RPM, давлений, температур, смесей, оверлеев и поведения в демо-потоке.
